name: App Store Release

# Uploads a Mac App Store build to App Store Connect, distributes to TestFlight,
# and optionally submits for App Store review.
#
# The provisioning profile is downloaded automatically from App Store Connect via
# `asc profiles list` — no need to store it as a secret.
#
# Required GitHub Secrets:
#   APPLE_MAS_CERTIFICATE_P12      — Base64-encoded P12 containing both:
#                                      • "3rd Party Mac Developer Application: ..." (signs the app)
#                                      • "3rd Party Mac Developer Installer: ..." (signs the PKG)
#                                    Different cert type from APPLE_CERTIFICATE_P12 (Developer ID).
#   APPLE_MAS_CERTIFICATE_PASSWORD — Password for APPLE_MAS_CERTIFICATE_P12
#   APP_STORE_CONNECT_KEY_ID      — App Store Connect API Key ID  (same key as APP_STORE_CONNECT_KEY_ID)
#   APP_STORE_CONNECT_ISSUER_ID   — Issuer ID UUID               (same as APP_STORE_CONNECT_ISSUER_ID)
#   APP_STORE_CONNECT_API_KEY_P8  — PEM content of .p8 file      (cat AuthKey_XXXX.p8 — NOT base64)
#
# Required GitHub Variables (Settings → Variables → Actions):
#   APP_ID              — Numeric App Store Connect app ID  (asc apps list)
#   BETA_GROUP_ID       — TestFlight beta group ID          (asc testflight groups list --app-id $APP_ID)
#   DEVELOPMENT_TEAM    — Apple Developer Team ID           (10-char string, e.g. ABCD123456)
#
# One-time setup (run locally with `asc` before first CI run):
#   asc bundle-ids list --identifier com.tddworks.claudebar --platform macos
#   asc certificates list --type MAC_APP_DISTRIBUTION
#   asc profiles create --name "ClaudeBar Mac App Store" --type MAC_APP_STORE \
#     --bundle-id-id <id> --certificate-ids <cert-id>

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version string (e.g. 1.2.0)'
        required: true
        type: string
      build_number:
        description: 'Build number (leave blank to use run number)'
        required: false
        type: string
      whats_new:
        description: 'TestFlight "What''s New" notes'
        required: false
        default: 'Bug fixes and improvements.'
        type: string
      submit_for_review:
        description: 'Submit to App Store after TestFlight distribution?'
        required: false
        type: boolean
        default: false

env:
  APP_NAME: ClaudeBar
  BUNDLE_ID: com.tddworks.claudebar
  SWIFT_VERSION: "6.2"
  APP_ID: ${{ vars.APP_ID }}
  BETA_GROUP_ID: ${{ vars.BETA_GROUP_ID }}

jobs:
  appstore-release:
    name: Build, Upload & (optionally) Submit
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: SwiftyLab/setup-swift@latest
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Install Tuist
        run: brew install tuist

      - name: Cache Tuist
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/tuist
            .tuist-cache
          key: ${{ runner.os }}-tuist-${{ hashFiles('Project.swift', 'Tuist.swift', 'Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-tuist-

      - name: Resolve Build Number
        id: build
        run: |
          BUILD_NUMBER="${{ inputs.build_number || github.run_number }}"
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Build: ${{ inputs.version }} ($BUILD_NUMBER)"

      - name: Update Info.plist Version
        run: |
          INFO_PLIST="Sources/App/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ inputs.version }}" "$INFO_PLIST"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ steps.build.outputs.build_number }}" "$INFO_PLIST"

      - name: Install Dependencies & Generate Xcode Project
        run: |
          tuist install
          tuist generate --no-open

      - name: Import Mac App Store Certificates
        env:
          APPLE_MAS_CERTIFICATE_P12: ${{ secrets.APPLE_MAS_CERTIFICATE_P12 }}
          APPLE_MAS_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_MAS_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/mas-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -hex 16)"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Download Apple certificate chain
          curl -sL -o "$RUNNER_TEMP/AppleRootCA-G2.cer" \
            "https://www.apple.com/certificateauthority/AppleRootCA-G2.cer"
          curl -sL -o "$RUNNER_TEMP/AppleWWDRCAG3.cer" \
            "https://www.apple.com/certificateauthority/AppleWWDRCAG3.cer"
          security import "$RUNNER_TEMP/AppleRootCA-G2.cer" -k "$KEYCHAIN_PATH" -T /usr/bin/codesign 2>&1 || true
          security import "$RUNNER_TEMP/AppleWWDRCAG3.cer"  -k "$KEYCHAIN_PATH" -T /usr/bin/codesign 2>&1 || true

          # Import Mac App Store certificates (Application + Installer, both in the P12)
          echo "$APPLE_MAS_CERTIFICATE_P12" | base64 --decode > "$RUNNER_TEMP/mas-cert.p12"
          security import "$RUNNER_TEMP/mas-cert.p12" \
            -k "$KEYCHAIN_PATH" \
            -P "$APPLE_MAS_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productbuild \
            -T /usr/bin/security \
            -f pkcs12

          security list-keychain -d user -s "$KEYCHAIN_PATH" $(security list-keychain -d user | xargs)
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH" 2>&1 || true

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: Install asc CLI
        run: brew tap tddworks/tap && brew install asccli

      - name: Setup ASC credentials
        # Decode the base64-encoded .p8 key into raw PEM that asc CLI expects via ASC_PRIVATE_KEY.
        # Setting all three vars in $GITHUB_ENV avoids repeating them in every asc step.
        env:
          ASC_PRIVATE_KEY_B64: ${{ secrets.APP_STORE_CONNECT_API_KEY_P8 }}
        run: |
          echo "ASC_KEY_ID=${{ secrets.APP_STORE_CONNECT_KEY_ID }}" >> $GITHUB_ENV
          echo "ASC_ISSUER_ID=${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" >> $GITHUB_ENV
          {
            echo 'ASC_PRIVATE_KEY<<EOF'
            echo "$ASC_PRIVATE_KEY_B64" | base64 --decode
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Download & Install Provisioning Profile
        # Downloads the MAC_APP_STORE profile directly from App Store Connect via `asc`.
        # No MAS_PROVISIONING_PROFILE secret needed — always fetches the latest version.
        # ASC_KEY_ID / ASC_ISSUER_ID / ASC_PRIVATE_KEY are set globally by "Setup ASC credentials".
        run: |
          # Resolve the bundle ID resource ID for this app
          BUNDLE_ID_ID=$(asc bundle-ids list --identifier "$BUNDLE_ID" --platform macos \
            | jq -r '.data[0].id')
          if [ -z "$BUNDLE_ID_ID" ] || [ "$BUNDLE_ID_ID" = "null" ]; then
            echo "Error: Bundle ID '$BUNDLE_ID' not found in App Store Connect"
            echo "Run: asc bundle-ids create --name ClaudeBar --identifier $BUNDLE_ID --platform macos"
            exit 1
          fi

          # Fetch the MAC_APP_STORE profile and extract its content
          PROFILE_JSON=$(asc profiles list --bundle-id-id "$BUNDLE_ID_ID" --type MAC_APP_STORE)
          PROFILE_CONTENT=$(echo "$PROFILE_JSON" | jq -r '.data[0].profileContent')
          PP_NAME=$(echo "$PROFILE_JSON" | jq -r '.data[0].name')

          if [ -z "$PROFILE_CONTENT" ] || [ "$PROFILE_CONTENT" = "null" ]; then
            echo "Error: No MAC_APP_STORE profile found for $BUNDLE_ID"
            echo "Run: asc profiles create --name 'ClaudeBar Mac App Store' --type MAC_APP_STORE \\"
            echo "       --bundle-id-id $BUNDLE_ID_ID --certificate-ids <cert-id>"
            exit 1
          fi

          # Decode and install the profile
          PP_PATH="$RUNNER_TEMP/mas.provisionprofile"
          echo "$PROFILE_CONTENT" | base64 --decode > "$PP_PATH"
          PP_UUID=$(security cms -D -i "$PP_PATH" | /usr/libexec/PlistBuddy -c 'Print UUID' /dev/stdin)
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PP_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/$PP_UUID.provisionprofile"

          echo "PP_NAME=$PP_NAME" >> $GITHUB_ENV
          echo "Installed profile: $PP_NAME ($PP_UUID)"

      - name: Archive for Mac App Store
        run: |
          xcodebuild archive \
            -workspace "${APP_NAME}.xcworkspace" \
            -scheme "${APP_NAME}" \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/${APP_NAME}.xcarchive" \
            -destination "generic/platform=macOS" \
            -skipMacroValidation \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="${{ vars.DEVELOPMENT_TEAM }}" \
            CODE_SIGN_IDENTITY="3rd Party Mac Developer Application" \
            PROVISIONING_PROFILE_SPECIFIER="$PP_NAME"

      - name: Export PKG for App Store
        run: |
          cat > "$RUNNER_TEMP/ExportOptions.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>destination</key>
            <string>export</string>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/${APP_NAME}.xcarchive" \
            -exportPath "$RUNNER_TEMP/Export" \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist"

          PKG_FILE=$(find "$RUNNER_TEMP/Export" -name "*.pkg" | head -1)
          if [ -z "$PKG_FILE" ]; then
            echo "Error: No PKG file found in export output"
            ls -la "$RUNNER_TEMP/Export/"
            exit 1
          fi
          echo "PKG_FILE=$PKG_FILE" >> $GITHUB_ENV
          echo "Exported: $PKG_FILE"

      - name: Upload to App Store Connect
        run: |
          asc builds upload \
            --app-id "$APP_ID" \
            --file "$PKG_FILE" \
            --version "${{ inputs.version }}" \
            --build-number "${{ steps.build.outputs.build_number }}" \
            --wait

      - name: Get Build ID
        run: |
          BUILD_ID=$(asc builds list --app-id "$APP_ID" | jq -r '.data[0].id')
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "Build ID: $BUILD_ID"

      - name: Distribute to TestFlight
        run: |
          asc builds add-beta-group \
            --build-id "$BUILD_ID" \
            --beta-group-id "$BETA_GROUP_ID"

          asc builds update-beta-notes \
            --build-id "$BUILD_ID" \
            --locale en-US \
            --notes "${{ inputs.whats_new }}"

      - name: Submit for App Store Review
        if: ${{ inputs.submit_for_review }}
        run: |
          VERSION_ID=$(asc versions list --app-id "$APP_ID" | jq -r '.data[0].id')
          asc versions set-build --version-id "$VERSION_ID" --build-id "$BUILD_ID"

          READINESS=$(asc versions check-readiness --version-id "$VERSION_ID")
          IS_READY=$(echo "$READINESS" | jq -r '.data[0].isReadyToSubmit')
          if [ "$IS_READY" != "true" ]; then
            echo "Version is NOT ready to submit:"
            echo "$READINESS" | jq '.data[0] | {stateCheck, buildCheck, pricingCheck}'
            exit 1
          fi

          asc versions submit --version-id "$VERSION_ID"

      - name: Cleanup
        if: always()
        run: |
          if [ -n "$KEYCHAIN_PATH" ] && [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi
          rm -f "$RUNNER_TEMP/mas-cert.p12" || true